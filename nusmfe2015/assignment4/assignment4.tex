\documentclass[10pt,a4paper,hidelinks,fleqn]{article}            % Article 12pt font for a4 paper while hiding links
\usepackage[margin=1in]{geometry}                          % Required to adjust margins
\usepackage{listings}% http://ctan.org/pkg/listings
\lstset{
  mathescape
}
\input{styleAndCommands}

\newcommand{\pder}[2]{\frac{\partial#1}{\partial#2}}
\newcommand{\pderSnd}[2]{\frac{\partial^2#1}{\partial#2^2}}

\title{\vspace{-5ex}Assignment 4, FE5116 (2014/2015, Semester 2)\vspace{-7ex}}
\date{}
\begin{document}
\maketitle

\subsection*{Excercise 4.1}
Price Asian call option with the one factor mean reverting commodity model (MR1)
\begin{align}
\frac{dF(t, T)}{F(t, T)} = \sigma e^{-\alpha (T- t)} dW_t
\end{align}
with constant $\sigma, \alpha > 0$.

The payoff of arithmetic Asian call option is $\max(A - K, 0)$ where 
\begin{align}
A = \frac{1}{n}\sum_{i=1}^n F(t_i, T_i).
\label{eq:average}
\end{align} 
You should use only one state variable $Z_t$ recommended in the lecture, which has diffusion:
\begin{align}
& dZ_t = -\alpha Z_t dt + dW_t, 
% & Z_{t+\Delta t} = Z_t e^{-\alpha \Delta t} + \sqrt{v_t} \epsilon_t, \\
% & v_t = \frac{1}{2\alpha}(1 - e^{-\alpha  \Delta t})
\end{align}
and the reconstruction
\begin{align}
F(t, T) & = F(0, T) \exp\left( -\frac{\sigma^2}{2} \int_0^t e^{-2\alpha (T - u)} du + \sigma e^{-\alpha(T-t)} Z_t \right)
%        & = F(0, T) \exp\left( \frac{\sigma^2}{4\alpha} e^{-2\alpha T} \left(1 - e^{2\alpha t}\right) + \sigma e^{-\alpha(T-t)} Z_t \right).
\end{align}
Implement a Monte Carlo Asian call option pricer for this model:
\vspace{-0.6cm}
\begin{lstlisting}
asianCallOptionMR1(rf, sigma, alpha, priceCurve, settleDate, strike, ti_s, Ti_s, nSim)
 % rf: the constant risk-free interest rate
 % sigma: the $\sigma$ as stated in equation (1) 
 % alpha: the $\alpha$ as stated in euqation (1)
 % priceCurve: a funciton of T, priceCurve(T) = F(0, T), 
 %             the forward prices for various maturities T's observed today 
 % settleDate: the option settlement date
 % strike: the option strike K
 % ti_s: array of double, the ti's appears in the Asian payoff
 % Ti_s: array of double, the forward delivery time corresponding to ti
 % nSim: number of Monte Carlo simulation paths
\end{lstlisting}
\vspace{-0.6cm}

The \verb=priceCurve= function can be generated by linearly interpolating the below observations with flat extrapolation (i.e., \verb=@(T) interp1(delivs, prices, T, "linear", "extrap")=:
\vspace{-0.6cm}
\begin{verbatim}
  delivs = [1/12, 2/12, 3/12, 6/12, 9/12, 1, 1.5, 2, 3, 5];
  prices = [43, 45, 47, 49.05, 50.37, 51.36, 52.3, 53.51, 54.6, 55.7];
\end{verbatim}
You are not required to check the validity of the inputs:
the observation time \verb=ti= in \eqref{eq:average} will always be smaller than the \verb=settleDate=, and the forward delivery time \verb=Ti= in \eqref{eq:average} will always be larger than their corresponding observation time \verb=ti=.
For example, an Asian option expiring in 1 year with 10 observations may have \verb_expiry = 1_, \verb+ti_s = [0.1, 0.2, ...1]+, and \verb+Ti_s = [1.1, 1.2, ...2]+;
or \verb+ti_s = [0.8, 0.82, 0.84, ...1]+ and \verb+Ti_s = [1.1, 1.1, 1.1, 1.2, 1.2, ..., 1.2]+. The second case is more frequently seen in practice because the underlying exchange listed forward contracts usually have fixed delivery dates instead of rolling.

(Note that this exercise can be used to benchmark a degenerate case of the project.)
\subsection*{Excercise 4.2}
A quanto option (\url{http://en.wikipedia.org/wiki/Quanto}), unlike a normal European option that pays the final payoff in the denominated currency of the underlying stock or asset,
it pays the final payoff in another currency at a pre-determined exchange rate.
For example, a dividend-free stock $S_a$ is listed in SGX and denominatd in SGD. 
A quanto call option allows the holder to receive the payoff $\max(S_a-K, 0)$ in JPY at a pre-fixed exchange rate $F = 80$. 

The payoff of the quanto call option in the stock's denominatd currency is thus 
$F \times \max(S_a(T)-K, 0) \times S_b(T)$ where $S_b$ is the value of one quanto currency in the unit of stock's denominated currency.

To price the option with Monte Carlo, one would need to simulate two assets: the stock $S_a$ and the exchange rate $S_b$.
Consider the below diffusion:
\begin{align}
& dS_a(t) / S_a(t) = (r_d - r_a) dt + \sigma_a dW_a \\
& dS_b(t) / S_b(t) = (r_d - r_b) dt + \sigma_b dW_b \\
& dW_a dW_b = \rho dt
\end{align}
where $r_d$ is the risk free interest rate of the stock's denominated currency, $r_a$ is the continuous yield of the stock, and $r_b$ is the interest rate of the quanto currency, and $\rho \in [-1, 1]$ is the correlation between the stock price and the foreign exchange rate.
Implement a Monte Carlo pricer to price the quanto call option in the stock's denominated currency
\begin{verbatim}
quantoCallOptionMC(rd, ra, rb, sigmaA, sigmaB, rho, s_a0, s_b0, T, K, F, nSim)
\end{verbatim}
where \verb=s_a0= and \verb=s_b0= are the current spot prices $S_a(0)$ and $S_b(0)$, 
and compare the result with the closed form solution:
\begin{align}
S_b(0) F e^{-r_bT}\left( S_a(0) N(d_+) - K N(d_-)  \right).
\end{align}
where
\begin{align*}
d_{\pm} = \frac{\ln \frac{S_a(0)}{K} + (r_d - r_a - \rho \sigma_a \sigma_b \pm \frac{1}{2}\sigma_a^2)T}{\sigma_a \sqrt{T}}
\end{align*}

\subsection*{Excercise 4.3}
Let us price derivatives with PDE for the one factor mean reverting model (MR1). 
Recall what we have seen in Exercise 3.1 the model diffusion:
\begin{align*}
\frac{dF(t, T)}{F(t, T)} = \sigma e^{-\alpha (T- t)} dW_t,
\end{align*}
our choice of state variable
\begin{align}
dZ_t = -\alpha Z_t dt + dW_t,
\end{align}
and the reconstruction for the futures prices:
\begin{align}
F(t, T) & = F(0, T) \exp\left( -\frac{\sigma^2}{2} \int_0^t e^{-2\alpha (T - u)} du + \sigma e^{-\alpha(T-t)} Z_t \right)
%        & = F(0, T) \exp\left( \frac{\sigma^2}{4\alpha} e^{-2\alpha T} \left(1 - e^{2\alpha t}\right) + \sigma e^{-\alpha(T-t)} Z_t \right).
\label{eq:mr1_reconstruction}
\end{align}
A derivative contract contingent on the value of $F(t, T)$ can be expressed as a derivative on the state variable $Z(t)$ through \eqref{eq:mr1_reconstruction}.
Assuming the interest rate is constant $r$,
%the price of the discounted derivative contract $V(t, Z(t))$ follows the SDE:
\begin{align}
d\left(\frac{V}{B}\right) & = \frac{1}{B}\left(\frac{\partial V}{\partial t} dt + \frac{\partial V}{\partial Z} dZ + \frac{1}{2}\frac{\partial^2 V}{\partial Z^2} dZ^2 \right) - r\frac{V}{B}dt  \\
   & = \frac{1}{B} \left[\left(\frac{\partial V}{\partial t} - \alpha Z\frac{\partial V}{\partial Z} + \frac{1}{2} \frac{\partial^2 V}{\partial Z^2} - rV\right)dt + \frac{\partial V}{\partial Z} dW_t \right]
\end{align}
%For $\frac{V}{B}$ to be a martingale, 
follow the derivation of the Black-Scholes PDE in the lecture notes (page 19),
demonstrate that the derivative contract price $V(t, Z(t))$ has to satisfy the PDE:
\begin{align}
rV(t) = \frac{\partial V(t)}{\partial t} - \alpha Z(t) \frac{\partial V(t)}{\partial Z} + \frac{1}{2} \frac{\partial^2 V(t)}{\partial Z^2}
\end{align}


Now, develop a PDE pricer that prices a European call option on the futures contract $F(t, T)$ with strike $K$ and expiry $t_e$ using implicit Euler scheme, with $Z_t$ as state variable.
The payoff at time $t_e$ of the function is $\max(F(t_e, T) - K, 0)$.
You should describe how to set up the initial value at the terminal time step $t_e$, the boundary conditions, and implement the pricer with the below signature:
\begin{verbatim}
callOnFuturesPDE(priceCurve, alpha, sigma, rf, expiry, T, K, nT, nZ, Zmax, Zmin)
\end{verbatim}
where the nT and nZ are the number of subdivisions that divides the time axis and state variable axis in equal spaces.
e\verb=Zmax= and \verb=Zmin= are the range of the state variable axis. \verb=riceCurve, alpha, sigma= are defined in the same way as Exercise 4.1.

\subsection*{Excercise 4.4}
Let us consider an ODE derived from the Heston model for the characteristic function \cite{heston93} of the log price:
\begin{align}
\pder{D}{\tau} = \frac{\sigma_v^2}{2} D^2 + (\rho\sigma_viu - \kappa)D - (\frac12 iu + \frac{u^2}{2})
\label{eq:complexODE}
\end{align}
subject to the initial conditions:
\begin{align}
D(0, u) = 0
\label{eq:initialValue}
\end{align}

Implement an ODE solver that solves the ODE \eqref{eq:complexODE}, \eqref{eq:initialValue} using Crank-Nicolson scheme,
and compare your numerical solution with the closed form solution:
\begin{align}
D(\tau, u) & = \frac{\kappa - \rho \sigma_v iu + d}{\sigma_v^2} \left( \frac{1-e^{d\tau}}{1-ge^{d\tau}} \right)
\label{eq:closedFormD}
\end{align}
where
\begin{align}
d & = \sqrt{(\rho \sigma_v iu - \kappa)^2 + \sigma_v^2 (iu+u^2)} \\
g & = \frac{\kappa - \rho \sigma_v iu + d}{\kappa - \rho \sigma_v iu - d}.
\end{align}
Here $D(\tau, u)$ in \eqref{eq:complexODE} is complex functions.
The parameters $\sigma_v > 0$, $\rho \in [-1, 1]$, $\kappa > 0$, are all constants. 
$i$ is the imaginary unit, and $u=a+ib$ is a complex number.
Le $D = D_R + iD_I$, by equating both the real and the imaginary part, 
our numerical ODE solver actually needs to solve a system of two ODEs:
\begin{align}
\begin{cases}
& \pder{D_R}{\tau} = \frac{1}{2}\sigma_v^2 (D_R^2 - D_I^2) - \kappa D_r  - \rho \sigma_v b D_r - \rho \sigma_v a D_I  + \frac{1}{2}(a^2 - b^2 - b) \\
& \pder{D_I}{\tau} = \sigma_v D_R D_I - \kappa D_I + \rho \sigma_v a D_r - \rho \sigma_v b D_I + 2ab + a \\ 
& D(0, u) = 0
\end{cases}
\end{align}

Typically, for Crank-Nicolson scheme, at every time step you need to solve 
\begin{align*}
\frac{D_{i+1} - D_i}{\Delta \tau} = \frac{1}{2}f(D_i) + \frac{1}{2}f(D_{i+1})
\end{align*}
where $f(.)$ is the function of $D$ at the right hand side of the ODE.
Note that the right hand side is quadratic, 
so a solver (e.g., \verb=fsolve()=, \url{https://www.gnu.org/software/octave/doc/interpreter/Solvers.html}) is required to find the $D_{i+1}$ given $D_i$.

You should implement two functions
\begin{verbatim}
charHestonODE(sigmaV, kappa, theta, rho, r, u, tau, nT)
charHestonAnalytic(sigmaV, kappa, theta, rho, r, u, tau)
\end{verbatim}
that solve for $D(\tau, u)$. 
Then compare the two solutions. For each $\tau \in [0.1, 0.5, 1, 2]$, and
\begin{align*}
~\theta = 1, ~\kappa = 0.2, ~\sigma_v = 2.0, ~\rho = -0.3, ~r = 0.02
\end{align*}
plot the function $D$ of $a = [0, 0.1, 0.2, ..., 20.0]$ and $b = -2$ (recall that $u = a+ib$). 
Each plot should overlay the PDE result with the closed form solution.
You should choose a reasonable number of time steps \verb=nT= for your ODE solver that gives satisfactory accuracy ($O(10^{-4})$) and speed.


\subsection*{Submission Checklist}
Below is the list of required files in the submission package:
\begin{itemize}
\item Exercise 4.1: asianCallOptionMR1.m, test41.m that runs your test, a brief description of the test result in the documentation.
\item Exercise 4.2: quantoCallOptionMC.m, test42.m that runs your test, a brief description of the test result in the documentation.
\item Exercise 4.3: callOnFuturesPDE.m, test43.m that runs your test, a brief description of the test result in the documentation.
\item Exercise 4.4: charHestonODE.m, charHestonAnalytic.m, and test44.m that generates the plots. The documentation should include the system of the 4 ODE's and summary of test results.
\end{itemize}
Please put all the documentation in a single PDF file named ex4.pdf.
You do not need to create sub-folders for the questions. 
To re-iterate, the filename of the zip file should be in the format of \verb=Ex4_name1_matricNumber1_name2_matricNumber2.zip=.
And the matric number should contain the last alphabetic letter if applicable. 


\bibliographystyle{abbrv}
\bibliography{qftn}


\end{document}


  
The spot diffusion under the Heston model is:
\begin{align}
& \frac{dS_t}{S_t} = r dt + \sqrt{v_t} dW_{1, t} \\
& dv_t = \kappa (\theta - v_t) dt + \sigma_v \sqrt{v_t} dW_{2, t}, \\
& dW_{1, t} dW_{2,t} = \rho dt
\end{align}
where $v_t$ represents the local variance and is itself stochastic and mean reverting to $\theta$.
$\sigma_v$ represents the volatility of volatility, and $r$ the risk-free interest rate. The parameters $\kappa, \theta, \sigma_v, \rho, r$ are all constants.

Let $Z_t = \ln S_t$, the diffusion of $Z_t$ is
\begin{align*}
d Z_t = (r - \frac{1}{2} v_t) dt + \sqrt{v_t} dW_{1, t}
\end{align*}
For fixed maturity T, the characteristic function of the random variable $Z_T$ can be defined as $\chi_T(u) = E[e^{iuZ_T}]$.
If the characteristic function is know, the terminal distribution at T is know and we can price European option using Fourier transform.
So the exercise here is to obtain $\chi_T(u)$.

Consider a process $X(t, Z_t, v_t, u) = E_t[e^{iuZ_T}]$, the characteristic function $\chi_T(u)$ becomes $X(0, Z_0, v_0, u)$.
Applying Ito's lemma we can obtain its diffusion:
\begin{align}
dX & = \pder{X}{t} dt + \pder{X}{Z} dZ + \pder{X}{v} dv + \frac{1}{2} \pderSnd{X}{Z} dZ^2 + \frac{1}{2} \pderSnd{X}{v} dv^2 + \frac{\partial^2 X}{\partial v \partial Z} dv dZ \\
   & = \left(\pder{X}{t} + (r-\frac{1}{2}v) \pder{X}{Z} + \kappa (\theta - v) \pder{X}{v}
       + \frac{v}{2} \pderSnd{X}{Z} + \frac{v\sigma_v^2}{2} \pderSnd{X}{v} + v\rho \sigma_v \frac{\partial^2 X}{\partial v \partial Z}
       \right) + \ldots
\end{align}
Note that we omit the diffusion part as we are interested in the drift term only.
Since $X_t$ is an expectation and therefore a martingale, the drift should be equal to 0, yielding the PDE:
\begin{align}
\pder{X}{t} + (r-\frac{1}{2}v) \pder{X}{Z} + \kappa (\theta - v) \pder{X}{v}
       + \frac{v}{2} \pderSnd{X}{Z} + \frac{v\sigma_v^2}{2} \pderSnd{X}{v} + v\rho \sigma_v \frac{\partial^2 X}{\partial v \partial Z} = 0       
\label{eq:pdeOfX}
\end{align}
Heston assumes the solution of the above PDE can be expressed by this form:
\begin{align}
X(t, Z_t, v_t, u) = \exp(C(\tau, u) + D(\tau, u) v_t + iuZ_t).
\end{align}
where $\tau = T - t$, $C(\tau, u)$ and $D(\tau, u)$ are complex functions.
The partial derivatives in \eqref{eq:pdeOfX} can be rewritten as
\begin{align*}
\pder{X}{t} = -X\left(\pder{C}{\tau} + \pder{D}{\tau} v\right),~~
\pder{X}{Z} = iuX, ~
\pder{X}{v} = DX, ~
\pderSnd{X}{Z} = -u^2X, ~
\pderSnd{X}{v} = D^2 X, ~
\frac{\partial^2X}{\partial Z \partial v} = iuD X.
\end{align*}
The PDE \eqref{eq:pdeOfX} can be re-arranged as
\begin{align}
-\pder{C}{\tau} - \pder{D}{\tau} v + iu(r-\frac{1}{2}v) + \kappa(\theta - v)D 
- \frac{vu^2}{2} + \frac{v \sigma_v^2}{2} D^2 + v\rho \sigma_v iuD = 0
\end{align}
Collecting all the $v$ terms we obtain
\begin{align}
\left[ -\pder{C}{\tau} + iur + \kappa \theta D \right] + v
\left[
-\pder{D}{\tau} - \frac12iu - \kappa D - \frac{u^2}{2} + \frac{\sigma_v^2}{2}D^2 + \rho \sigma_v iuD
\right] = 0
\end{align}
Since the PDE should hold for all $v$, we obtain the following ODE system
